import{_ as e,c as n,j as i,a as t,t as l,a0 as h,o as p}from"./chunks/framework.pWuaoOf3.js";const k="data:image/svg+xml,%3csvg%20id='Layer_1'%20data-name='Layer%201'%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%20287.36395%20111.36238'%3e%3cdefs%3e%3cstyle%3e.cls-1{fill:%23384745;}.cls-2{fill:%23ffc61c;}%3c/style%3e%3c/defs%3e%3ctitle%3esub-project-brand-logo-variants%3c/title%3e%3cpath%20class='cls-1'%20d='M163.81972,30.43153H176.3161V44.57461c0,1.57118-.22411,3.89019-.37392,5.6124h.29962a42.96588,42.96588,0,0,1,3.14237-4.71476l12.34717-15.04072h13.46893L188.73818,50.26131l17.36034,30.67946H191.73134L180.0577,59.76513l-3.7416,4.565V80.94077H163.81972Z'/%3e%3cpath%20class='cls-1'%20d='M218.29711,65.07792c-1.34708,4.86336,1.42137,7.93143,5.6118,7.93143,4.71415,0,7.10868-3.74161,7.10868-9.0544,0-5.6867-2.84335-7.85591-6.65986-7.85591a9.07616,9.07616,0,0,0-6.21043,2.39453l-5.3877-5.83773L228.399,39.71h-18.5576v-9.2785h31.054v9.80223L228.92268,50.1115c7.63241-.74783,14.89091,4.26533,14.89091,13.99326,0,10.55128-8.60557,17.73487-19.45586,17.73487-10.251,0-18.85662-6.36024-16.6119-15.266Z'/%3e%3cpath%20class='cls-1'%20d='M259.30374,64.33009c-.89765,4.04.67354,8.67926,8.60557,8.67926,5.23727,0,7.03378-2.09491,7.03378-4.86458,0-4.18982-4.191-5.23727-9.12991-7.03256-7.40709-2.54556-16.53638-6.13614-16.53638-16.68741,0-9.42831,7.25849-15.19053,19.60445-14.89091,15.11623.2984,19.38156,9.2042,17.73487,16.91152L275.1672,47.49286c.74905-5.83651-1.34708-9.1299-7.25789-9.1299-3.96571,0-6.211,1.4981-6.211,4.64046,0,4.18982,4.04062,5.46138,8.97949,7.18359,7.633,2.54313,16.68619,5.61241,16.68619,16.087,0,9.05439-6.73416,15.56566-19.90407,15.56566-12.34657,0-20.80233-5.68792-19.08073-16.46209Z'/%3e%3cpath%20class='cls-2'%20d='M121.58689,0H14.39255A14.43487,14.43487,0,0,0,0,14.39247V96.96991a14.43487,14.43487,0,0,0,14.39255,14.39247H121.58689a14.43487,14.43487,0,0,0,14.39255-14.39247V14.39247A14.43487,14.43487,0,0,0,121.58689,0ZM57.45811,80.98065,31.29766,96.18344A6.99993,6.99993,0,1,1,24.26348,84.079L50.42393,68.87626a6.99993,6.99993,0,1,1,7.03418,12.10439Zm10.2915-23.16221h-.03145A6.99967,6.99967,0,0,1,60.74893,50.788l.13125-30.13725a7.00056,7.00056,0,0,1,6.99931-6.96958h.03145a6.99991,6.99991,0,0,1,6.96924,7.03042l-.13125,30.13725A7.00056,7.00056,0,0,1,67.74961,57.81844Zm46.2875,35.81006a6.997,6.997,0,0,1-9.56211,2.56211L78.27627,81.06473a6.99994,6.99994,0,1,1,7-12.12421L111.475,84.06639A6.99956,6.99956,0,0,1,114.03711,93.6285Z'/%3e%3c/svg%3e",r="/pikube-kubernetes-service/assets/how-k3s-works.P3kDY-x6.svg",o="/pikube-kubernetes-service/assets/k3s-high-availability.drawio.00l-Str3.svg",C=JSON.parse('{"title":"K3S Installation","description":"How to install K3s, a lightweight kubernetes distribution, in the PiKube Kubernetes Service. Single master node and high availability deployment can be used.","frontmatter":{"title":"K3S Installation","permalink":"/documentation/5-networking/2-k3s-installation/","description":"How to install K3s, a lightweight kubernetes distribution, in the PiKube Kubernetes Service. Single master node and high availability deployment can be used.","last_modified_at":"12-11-2023"},"headers":[],"relativePath":"4-kubernetes/1-k3s-installation.md","filePath":"4-kubernetes/1-k3s-installation.md"}'),d={name:"4-kubernetes/1-k3s-installation.md"},c={id:"frontmatter-title",tabindex:"-1"};function g(a,s,F,y,u,E){return p(),n("div",null,[i("h1",c,[t(l(a.$frontmatter.title)+" ",1),s[0]||(s[0]=i("a",{class:"header-anchor",href:"#frontmatter-title","aria-label":'Permalink to "{{ $frontmatter.title }}"'},"â€‹",-1))]),s[1]||(s[1]=h('<p align="center"><img alt="k3s-installation" src="'+k+'" width="60%" height="%"></p><p align="center"><img alt="k3s-installation" src="'+r+`" width="%" height="%"></p><p><strong><code>K3S</code></strong> simplifies the traditional Kubernetes setup by encapsulating all its processes into a singular binary. This binary can be rolled out on servers, adopting one of two specific roles: either <strong><code>k3s-server</code></strong> or <strong><code>k3s-agent</code></strong>.</p><ul><li><p><strong><code>k3s-server</code></strong>: This role initializes all the control plane processes of Kubernetes, including the API, Scheduler, and Controller. Additionally, it also runs worker processes such as Kubelet and kube-proxy. This means that a master node can double up as a worker node too.</p></li><li><p><strong><code>k3s-agent</code></strong>: This role focuses solely on the worker processes of Kubernetes, which are the Kubelet and kube-proxy.</p></li></ul><p>For the setup, the Kubernetes cluster will span 7 nodes</p><ul><li><strong><code>blueberry-master</code></strong> - <em>node 1</em></li><li><strong><code>strawberry-master</code></strong> - <em>node 2</em></li><li><strong><code>blackberry-master</code></strong> - <em>node 3</em></li><li><strong><code>cranberry-worker</code></strong> - <em>node 4</em></li><li><strong><code>raspberry-worker</code></strong> - <em>node 5</em></li><li><strong><code>orange-worker</code></strong> - <em>node 6</em></li><li><strong><code>mandarine-worker</code></strong> - <em>node 7</em></li></ul><p>Among these, <code>node 1</code> to <code>node 3</code> will be designated as the <code>control-plane</code>, whereas <code>node 4</code> to <code>node 7</code> will function as <code>worker nodes</code>.</p><h2 id="node-pre-configuration" tabindex="-1">Node Pre-configuration <a class="header-anchor" href="#node-pre-configuration" aria-label="Permalink to &quot;Node Pre-configuration&quot;">â€‹</a></h2><p>Configure iptables for Bridged Traffic to ensure iptables can observe bridged traffic</p><ul><li>Load the <strong><code>br_netfilter</code></strong> kernel module</li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">echo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;br_netfilter&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> tee</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /etc/modules-load.d/k8s.conf</span></span></code></pre></div><ul><li>Adjust settings to enable netfilter for bridged IPv6 and IPv4 traffic</li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">cat</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &lt;&lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">EOF</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> tee</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /etc/sysctl.d/k8s.conf</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">net.bridge.bridge-nf-call-ip6tables = 1</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">net.bridge.bridge-nf-call-iptables = 1</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">EOF</span></span></code></pre></div><ul><li>Apply the updated system control settings</li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> sysctl</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --system</span></span></code></pre></div><blockquote><p>ðŸš¨ Warning</p><ul><li><em>Deactivate Swap Memory (Applicable only for x86 nodes so not applicable to Raspberry Pis &amp; Orange Pis)</em></li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> swapoff</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -a</span></span></code></pre></div><p><em>To make this change persistent, open <strong><code>/etc/fstab</code></strong> and comment out the line related to swap memory.</em></p></blockquote><ul><li>Activate <strong><code>cgroup</code></strong> functionalities on Raspberry Pi Nodes by updating <strong><code>/boot/firmware/cmdline.txt</code></strong>. <strong><code>cgroup</code></strong> functionalities activation on Orange Pi Nodes is not needed.</li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">cgroup_enable</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">cpuset</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> cgroup_memory</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> cgroup_enable</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">memory</span></span></code></pre></div><p>To apply all the changes and ensure they take effect, reboot the server or node</p><h2 id="configuring-a-high-availability-k3s-cluster" tabindex="-1">Configuring a High-Availability K3s Cluster <a class="header-anchor" href="#configuring-a-high-availability-k3s-cluster" aria-label="Permalink to &quot;Configuring a High-Availability K3s Cluster&quot;">â€‹</a></h2><p>To achieve high availability (HA) with K3s:</p><ul><li>Deploy a minimum of three server nodes. These nodes will manage the Kubernetes API and oversee the control plane services.</li><li>Utilize an embedded etcd datastore, a shift from the default embedded SQLite used in single-server configurations.</li></ul><p align="center"><img alt="k3s-installation" src="`+o+`" width="%" height="%"></p><p><a id="load-balancer-setup-with-ha-proxy"></a></p><h3 id="load-balancer-setup-with-ha-proxy" tabindex="-1">Load Balancer setup with HA Proxy <a class="header-anchor" href="#load-balancer-setup-with-ha-proxy" aria-label="Permalink to &quot;Load Balancer setup with HA Proxy&quot;">â€‹</a></h3><p>For continuous availability of the Kubernetes API, implement a load balancer. In this setup, HAProxy will be used, a prominent network load balancer.</p><blockquote><p>ðŸ“Œ <strong><code>Note:</code></strong></p><p><em>For HA installations with K3s, configuration parameters will be supplied via config files rather than direct arguments or environment variables during installation.</em></p><p><em>HAProxy load balancer will reside on the gateway node.</em></p><p>ðŸ“¢ <strong><code>Important:</code></strong></p><p><em>This specific configuration presents a single point of failure since HAProxy isn&#39;t in an HA mode. To achieve a genuine high-availability setup for the load balancer, pair HAProxy with Keepalived.</em></p></blockquote><ul><li>Installing and Configuring <strong><code>HAProxy</code></strong></li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> apt</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> install</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> haproxy</span></span></code></pre></div><ul><li>Edit the HAProxy configuration at <strong><code>/etc/haproxy/haproxy.cfg</code></strong></li></ul><div class="language-ini vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ini</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#---------------------------------------------------------------------</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Global settings</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#---------------------------------------------------------------------</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">global</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  # Define the logging services</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  log /dev/log  local0</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  log /dev/log  local1 notice</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  # Specify the HAProxy user and group</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  user haproxy</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  group haproxy</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  # Run as a daemon</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  daemon</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  # Chroot directory for added security</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  chroot /var/lib/haproxy</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  # Admin socket for management</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  stats socket /run/haproxy/admin.sock mode 660 level admin expose-fd listeners</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  stats timeout 30s</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#---------------------------------------------------------------------</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Default settings</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#---------------------------------------------------------------------</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">defaults</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  # Use the global logging settings</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  log global</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  # Mode &amp; options</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  mode http</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  option httplog</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  option dontlognull</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  # Retry settings</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  retries 3</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  # Timeouts for various operations</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  timeout http-request 10s</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  timeout queue 20s</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  timeout connect 10s</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  timeout client 1h</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  timeout server 1h</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  timeout http-keep-alive 10s</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  timeout check 10s</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  # HTTP error files</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  errorfile 400 /etc/haproxy/errors/400.http</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  errorfile 403 /etc/haproxy/errors/403.http</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  errorfile 408 /etc/haproxy/errors/408.http</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  errorfile 500 /etc/haproxy/errors/500.http</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  errorfile 502 /etc/haproxy/errors/502.http</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  errorfile 503 /etc/haproxy/errors/503.http</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  errorfile 504 /etc/haproxy/errors/504.http</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#---------------------------------------------------------------------</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Frontend for Kubernetes API Server</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#---------------------------------------------------------------------</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">frontend k8s_apiserver</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # Listen on all interfaces on port 6443</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    bind *:6443</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # TCP mode with logging</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    mode tcp</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    option tcplog</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # Send incoming traffic to the backend</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    default_backend k8s_controlplane</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#---------------------------------------------------------------------</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Backend for Kubernetes Control Plane</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#---------------------------------------------------------------------</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">backend k8s_controlplane</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # Health check settings</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    option httpchk GET /healthz</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    http-check expect status 200</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # TCP mode with SSL checks</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    mode tcp</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    option ssl-hello-chk</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # Load balancing strategy</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    balance roundrobin</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # List of control plane nodes</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    server blueberry-master 10.0.0.10:6443 check</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    server strawberry-master 10.0.0.11:6443 check</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    server blackberry-master 10.0.0.12:6443 check</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#---------------------------------------------------------------------</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Stats settings (add this section to resolve the warning)</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#---------------------------------------------------------------------</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">listen stats</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    bind *:9000</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    mode http</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    stats enable</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    stats hide-version</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    stats uri /stats</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    stats realm Haproxy\\ Statistics</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    stats auth admin:admin</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # Set the required timeouts for the &#39;stats&#39; section</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    timeout client  10m</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    timeout connect 10m</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    timeout server  10m</span></span></code></pre></div><p>With this setup, <strong><code>HAProxy</code></strong> will distribute API server requests (on TCP port 6443) between the three master nodes using a <strong><code>round-robin strategy</code></strong>. The designated IP address for the Kubernetes API corresponds to the gateway&#39;s IP.</p><ul><li>Restart HAProxy</li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> systemctl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> restart</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> haproxy</span></span></code></pre></div><ul><li>Check HAProxy config is valid</li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> haproxy</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -c</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -f</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /etc/haproxy/haproxy.cfg</span></span></code></pre></div><ul><li>Enable HAProxy at Boot</li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">systemctl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> enable</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> haproxy</span></span></code></pre></div><h3 id="setting-up-master-nodes" tabindex="-1">Setting Up Master Nodes <a class="header-anchor" href="#setting-up-master-nodes" aria-label="Permalink to &quot;Setting Up Master Nodes&quot;">â€‹</a></h3><blockquote><p>ðŸš¨ <strong><code>IMPORTANT</code></strong></p><p><em>Before going further, <a href="https://github.com/Crypto-Aggressor/PiKube-Kubernetes-Cluster/blob/production/documentation/2.4-k3s-installation.md#1-node-pre-configuration" target="_blank" rel="noreferrer"><strong><code>Node Pre-configuration</code></strong></a> need to be completed.</em></p></blockquote><p>For a High-Availability configuration, the embedded etcd datastore will be utilized. A comprehensive guide can be found in the K3S documentation under <a href="https://docs.k3s.io/datastore/ha-embedded" target="_blank" rel="noreferrer"><strong><code>High Availability with Embedded etcd</code></strong></a></p><ul><li>Initialize Configuration Directory</li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> mkdir</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -p</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /etc/rancher/k3s</span></span></code></pre></div><ul><li>Establish a shared cluster token to be stored in <strong><code>/etc/rancher/k3s/cluster-token</code></strong>. This token acts as a shared secret for all cluster nodesâ€”both master and worker. Generate a random token, insert it in <strong><code>/etc/rancher/k3s/cluster-token</code></strong> file and grant it the right permissions.</li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">PIKUBE_TOKEN</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">openssl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> rand</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -base64</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 32</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">echo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;secret1&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> tee</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /etc/rancher/k3s/cluster-token</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> chmod</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 600</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /etc/rancher/k3s/cluster-token</span></span></code></pre></div><ul><li>Craft the K3S Kubelet Configuration in <strong><code>/etc/rancher/k3s/kubelet.config</code></strong> to use <strong><code>--token-file</code></strong> argument during installation instead of the <strong><code>K3S_TOKEN</code></strong> environment variable</li></ul><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">apiVersion</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">kubelet.config.k8s.io/v1beta1</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">kind</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">KubeletConfiguration</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">shutdownGracePeriod</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">30s</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">shutdownGracePeriodCriticalPods</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">10s</span></span></code></pre></div><ul><li>Formulate a K3S configuration file at <strong><code>/etc/rancher/k3s/config.yaml</code></strong> to activates Kubernetes&#39; &quot;Graceful Node Shutdown&quot; feature</li></ul><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">token-file</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">/etc/rancher/k3s/cluster-token</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">disable</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">- </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">local-storage</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">- </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">servicelb</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">- </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">traefik</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">etcd-expose-metrics</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">kube-controller-manager-arg</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">- </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">bind-address=0.0.0.0</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">- </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">terminated-pod-gc-threshold=10</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">kube-proxy-arg</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">- </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">metrics-bind-address=0.0.0.0</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">kube-scheduler-arg</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">- </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">bind-address=0.0.0.0</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">kubelet-arg</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">- </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">config=/etc/rancher/k3s/kubelet.config</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">node-taint</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">- </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">node-role.kubernetes.io/master=true:NoSchedule</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">tls-san</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">- </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">10.0.0.1</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">- </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">gateway.picluster.homelab.com</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">write-kubeconfig-mode</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">644</span></span></code></pre></div><blockquote><p>ðŸ“Œ Note</p><p><em>The configuration parameters mirror the command-line arguments usually used with K3S. For instance, <strong><code>token-file: /etc/rancher/k3s/cluster-token</code></strong> equates to <strong><code>--token-file /etc/rancher/k3s/cluster-token</code></strong></em></p></blockquote><ul><li><p>In this setup, we&#39;re emphasizing:</p><ul><li>The use of the <strong><code>token-file</code></strong> parameter instead of the <strong><code>K3S_TOKEN</code></strong> environment variable</li><li>The inclusion of the K3S API load balancer IP via the <strong><code>tls-san</code></strong> parameter for the TLS certificate</li><li>The exposition of etcd metrics with <strong><code>etcd-expose-metrics</code></strong></li></ul></li><li><p>Deploy the Primary Master Node <strong><code>blueberry-master</code></strong></p></li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">curl</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -sfL</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> https://get.k3s.io</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> sh</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -s</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> -</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> server</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --cluster-init</span></span></code></pre></div><ul><li>Roll Out the Secondary Master Nodes <strong><code>strawberry-master</code></strong>, and <strong><code>blackberry-master</code></strong></li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">curl</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -sfL</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> https://get.k3s.io</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> sh</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -s</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> -</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> server</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --server</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> https://gateway.picluster.homelab.com:6443</span></span></code></pre></div><h3 id="update-master-nodes" tabindex="-1">Update Master Nodes <a class="header-anchor" href="#update-master-nodes" aria-label="Permalink to &quot;Update Master Nodes&quot;">â€‹</a></h3><p>From <strong><code>blueberry-master</code></strong> get the node token</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">node_token</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> cat</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /var/lib/rancher/k3s/server/node-token</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre></div><ul><li>Stop the running Master node</li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> systemctl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> stop</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> k3s</span></span></code></pre></div><ul><li>Ensure <em><code>jq</code></em> is installed</li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> apt</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> install</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> jq</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -y</span></span></code></pre></div><ul><li>Get the latest K3S version</li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">latest_version</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">curl</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -s</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> https://api.github.com/repos/k3s-io/k3s/releases/latest</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> jq</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -r</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;.tag_name&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre></div><ul><li>Upgrade to the latest version</li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">curl</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -sfL</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> https://get.k3s.io</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> INSTALL_K3S_VERSION=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$latest_version </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">sh</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -s</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> -</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> server</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --server</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> https://gateway.picluster.homelab.com:6443</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --token</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $node_token</span></span></code></pre></div><h3 id="setting-up-worker-nodes" tabindex="-1">Setting Up Worker Nodes <a class="header-anchor" href="#setting-up-worker-nodes" aria-label="Permalink to &quot;Setting Up Worker Nodes&quot;">â€‹</a></h3><ul><li>Initialize Configuration Directory</li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> mkdir</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -p</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /etc/rancher/k3s</span></span></code></pre></div><ul><li>Retreive <strong><code>cluster-token</code></strong> used to setup the Master Nodes and insert it in <strong><code>/etc/rancher/k3s/cluster-token</code></strong>. This token acts as a shared secret for all cluster nodesâ€”both master and worker</li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">echo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;secret1&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> tee</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /etc/rancher/k3s/cluster-token</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> chmod</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 600</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /etc/rancher/k3s/cluster-token</span></span></code></pre></div><ul><li>Craft the K3S Kubelet Configuration in <strong><code>/etc/rancher/k3s/kubelet.config</code></strong> to use <strong><code>--token-file</code></strong> argument during installation instead of the <strong><code>K3S_TOKEN</code></strong> environment variable</li></ul><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">apiVersion</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">kubelet.config.k8s.io/v1beta1</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">kind</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">KubeletConfiguration</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">shutdownGracePeriod</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">30s</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">shutdownGracePeriodCriticalPods</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">10s</span></span></code></pre></div><ul><li>Formulate a K3S configuration file at <strong><code>/etc/rancher/k3s/config.yaml</code></strong> to activates Kubernetes&#39; &quot;Graceful Node Shutdown&quot; feature</li></ul><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">token-file</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">/etc/rancher/k3s/cluster-token</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">node-label</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;node_type=worker&#39;</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">kubelet-arg</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;config=/etc/rancher/k3s/kubelet.config&#39;</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">kube-proxy-arg</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;metrics-bind-address=0.0.0.0&#39;</span></span></code></pre></div><blockquote><p>ðŸ“Œ Note</p><p><em>This setup is equivalent to running k3s with the following arguments:</em></p><p><strong>--token-file /etc/rancher/k3s/cluster-token</strong></p><p><strong>--node-label &#39;node_type=worker&#39;</strong></p><p><strong>--kubelet-arg &#39;config=/etc/rancher/k3s/kubelet.config&#39;</strong></p><p><strong>--kube-proxy-arg &#39;metrics-bind-address=0.0.0.0&#39;</strong></p></blockquote><ul><li>Installing the Agent Node</li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">curl</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -sfL</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> https://get.k3s.io</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> sh</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -s</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> -</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> agent</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --server</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> https://gateway.picluster.quantfinancehub.com:6443</span></span></code></pre></div><ul><li>Label the Worker Nodes from within <strong><code>gateway</code></strong></li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">kubectl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> label</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> nodes</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">worker-node-nam</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">e</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> node-role.kubernetes.io/worker=worker</span></span></code></pre></div><h3 id="update-worker-nodes" tabindex="-1">Update Worker Nodes <a class="header-anchor" href="#update-worker-nodes" aria-label="Permalink to &quot;Update Worker Nodes&quot;">â€‹</a></h3><p>From <strong><code>blueberry-master</code></strong> get the node token</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">node_token</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> cat</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /var/lib/rancher/k3s/server/node-token</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre></div><p>On target node, export the token retrieved</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> node_token</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Master_Node_Key</span></span></code></pre></div><ul><li>Stop the running Worker node</li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> systemctl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> stop</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> k3s-agent</span></span></code></pre></div><ul><li>Ensure <em><code>jq</code></em> is installed</li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> apt</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> install</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> jq</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -y</span></span></code></pre></div><ul><li>Get the latest K3S version</li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">latest_version</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">curl</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -s</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> https://api.github.com/repos/k3s-io/k3s/releases/latest</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> jq</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -r</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;.tag_name&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre></div><ul><li>Upgrade to the latest version</li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> curl</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -sfL</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> https://get.k3s.io</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> K3S_URL</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">https://gateway.picluster.quantfinancehub.com:6443</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> K3S_TOKEN</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$node_token</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> INSTALL_K3S_VERSION</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$latest_version</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> sh</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> -</span></span></code></pre></div><h2 id="interacting-with-k3s" tabindex="-1">Interacting with K3S <a class="header-anchor" href="#interacting-with-k3s" aria-label="Permalink to &quot;Interacting with K3S&quot;">â€‹</a></h2><p>To set up remote access to the Kubernetes Cluster from <strong><code>gateway</code></strong>, begin by retrieving the <strong><code>k3s-config.yaml</code></strong> file from the primary master node, <strong><code>blueberry-master</code></strong>. This file, integral to K3s configuration, contains essential information such as:</p><ul><li><p><strong><code>Kubernetes Configuration</code></strong>: Standard settings for your Kubernetes cluster, as Kubernetes typically relies on YAML files for configuration.</p></li><li><p><strong><code>Cluster Settings</code></strong>: Specific settings for the K3s distribution, including server URLs and authentication data, crucial for the operation and communication of K3s nodes and clients within the cluster.</p></li><li><p><strong><code>Context and Credential Information</code></strong>: Details defining default clusters, users, and namespaces, along with user credentials like client certificates or tokens.</p></li><li><p><strong><code>Client Configuration</code></strong>: This enables tools like kubectl, the Kubernetes command-line tool, to interact with your K3s cluster when used as a kubeconfig file.</p></li><li><p><strong><code>Edge Computing Optimizations</code></strong>: Given K3sâ€™s emphasis on edge computing, the file may contain configurations tailored for low-resource environments, aiming to reduce memory and CPU usage.</p></li></ul><p>Follow these commands to transfer and configure the file:</p><ul><li>On <strong><code>blueberry-master</code></strong>: copy <strong><code>k3s.yaml</code></strong>, setting appropriate permissions:</li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> cp</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /etc/rancher/k3s/k3s.yaml</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ~/k3s.yaml</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> chown</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> pi:users</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ~/k3s.yaml</span></span></code></pre></div><ul><li><p>On <strong><code>gateway</code></strong>: create a <strong><code>.kube</code></strong> folder and copy <strong><code>k3s.yaml</code></strong> from <strong><code>blueberry-master</code></strong>, renaming it to <strong><code>config.yaml</code></strong>.</p></li><li><p>Modify the server address to match the gateway&#39;s IP instead of the default loopback address:</p></li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> scp</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -i</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ~/.ssh/gateway-pi</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> pi@blueberry-master:~/k3s.yaml</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ~/.kube/config.yaml</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> chown</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> root:root</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /home/pi/.kube</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -R</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> chmod</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 644</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /home/pi/.kube/config.yaml</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> nano</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ~/.kube/config.yaml</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># In the file, replace &#39;server: https://127.0.0.1:6443&#39; with &#39;server: https://10.0.0.1:6443&#39;</span></span></code></pre></div><h3 id="leveraging-kubectl" tabindex="-1">Leveraging kubectl <a class="header-anchor" href="#leveraging-kubectl" aria-label="Permalink to &quot;Leveraging kubectl&quot;">â€‹</a></h3><p>Install <strong><code>kubectl</code></strong>, Kubernetes&#39;s command-line tool, on the <strong><code>gateway</code></strong>:</p><ul><li>Download the latest stable version of <strong><code>kubectl</code></strong> for Linux (ARM64 architecture):</li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">curl</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -LO</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;https://dl.k8s.io/release/$(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">curl</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -L</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -s</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> https://dl.k8s.io/release/stable.txt)/bin/linux/arm64/kubectl&quot;</span></span></code></pre></div><ul><li>Make the downloaded file executable:</li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">chmod</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> +x</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> kubectl</span></span></code></pre></div><p>Move the executable to <strong><code>/usr/local/bin</code></strong> to make it available system-wide:</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> mv</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> kubectl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /usr/local/bin/</span></span></code></pre></div><ul><li>(Optional) Remove the downloaded file if it&#39;s no longer needed:</li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">rm</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> kubectl</span></span></code></pre></div><h3 id="leveraging-helm" tabindex="-1">Leveraging Helm <a class="header-anchor" href="#leveraging-helm" aria-label="Permalink to &quot;Leveraging Helm&quot;">â€‹</a></h3><p>Install <strong><code>helm</code></strong>, Kubernetes&#39;s package manager, on the <strong><code>gateway</code></strong>:</p><ul><li>Download the Helm Installation Script: This script will automatically fetch the latest version of Helm and install it:</li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">curl</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -fsSL</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -o</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> get_helm.sh</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3</span></span></code></pre></div><ul><li>Make the downloaded file executable:</li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">chmod</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 700</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> get_helm.sh</span></span></code></pre></div><p>Run the Installation Script: This will install Helm on the system:</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">./get_helm.sh</span></span></code></pre></div><ul><li>(Optional) Remove the downloaded file if it&#39;s no longer needed:</li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">rm</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> get_helm.sh</span></span></code></pre></div><h3 id="leveraging-k9s" tabindex="-1">Leveraging K9S <a class="header-anchor" href="#leveraging-k9s" aria-label="Permalink to &quot;Leveraging K9S&quot;">â€‹</a></h3><p>Install <strong><code>K9s</code></strong>, on the <strong><code>gateway</code></strong>, a terminal-based UI to interact with the Kubernetes clusters, providing a more efficient and streamlined way to manage Kubernetes resources.</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Fetch the latest k9s release version, download, extract, and install it</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">curl</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -s</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> https://api.github.com/repos/derailed/k9s/releases/latest</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> grep</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;browser_download_url.*Linux_arm64.tar.gz&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> cut</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -d</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> :</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -f</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 2,3</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> tr</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -d</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> wget</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -qi</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> -</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">tar</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -zxvf</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> k9s_Linux_arm64.tar.gz</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> k9s</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&amp;&amp; </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> mv</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> k9s</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /usr/local/bin/</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&amp;&amp; </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">rm</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> k9s_Linux_arm64.tar.gz</span></span></code></pre></div><h2 id="k3s-cluster-automatic-upgrade" tabindex="-1">K3S Cluster automatic upgrade <a class="header-anchor" href="#k3s-cluster-automatic-upgrade" aria-label="Permalink to &quot;K3S Cluster automatic upgrade&quot;">â€‹</a></h2><p>K3s clusters can be seamlessly upgraded using the <strong><code>Rancherâ€™s system-upgrade-controller</code></strong>. This controller utilizes a <strong><code>Custom Resource Definition</code></strong> (CRD) named <strong><code>&quot;Plan&quot;</code></strong> to schedule and execute upgrades in accordance with the specified upgrade plans. For more comprehensive details, refer to the <a href="https://docs.k3s.io/upgrades/automated" target="_blank" rel="noreferrer"><strong><code>K3S Automated Upgrades documentation</code></strong></a>.</p><p>From <strong><code>gateway</code></strong>, install Rancherâ€™s System Upgrade Controller by deploying the controller in <strong><code>pi-cluster</code></strong> using <strong><code>kubectl</code></strong>:</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> kubectl</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --kubeconfig=/home/pi/.kube/config.yaml</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> apply</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -f</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> https://github.com/rancher/system-upgrade-controller/releases/latest/download/system-upgrade-controller.yaml</span></span></code></pre></div><p>Check the output</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">namespace/system-upgrade</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> created</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">serviceaccount/system-upgrade</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> created</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">clusterrolebinding.rbac.authorization.k8s.io/system-upgrade</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> created</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">configmap/default-controller-env</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> created</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">deployment.apps/system-upgrade-controller</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> created</span></span></code></pre></div><p>To <strong><code>Configure Upgrade Plans</code></strong>, at least two separate upgrade plans needs to be set up : one for the server (master) nodes and another for the agent (worker) nodes.</p><ul><li>Get the latest K3S version</li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">latest_version</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">curl</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -s</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> https://api.github.com/repos/k3s-io/k3s/releases/latest</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> jq</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -r</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;.tag_name&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre></div><ul><li><p>Replace <strong><code>&lt;new_version&gt;</code></strong> with <strong><code>$latest_version</code></strong> value on both plans.</p></li><li><p>Plan for Master Nodes creating <strong><code>k3s-server-upgrade.yaml</code></strong> on <strong><code>gateway</code></strong>:</p></li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">apiVersion:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> upgrade.cattle.io/v1</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">kind:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Plan</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">metadata:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  name:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> k3s-server</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  namespace:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> system-upgrade</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  labels:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    k3s-upgrade:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> server</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">spec:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  nodeSelector:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    matchExpressions:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      -</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> key:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> node-role.kubernetes.io/control-plane</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        operator:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Exists</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  serviceAccountName:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> system-upgrade</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  concurrency:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  cordon:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> true</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  # Cordon node before upgrade</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  upgrade:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    image:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> rancher/k3s-upgrade</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  version:</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">new_versio</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">n</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span></span></code></pre></div><ul><li>Plan for Worker Nodes creating <strong><code>k3s-agent-upgrade.yaml</code></strong> on <strong><code>gateway</code></strong>:</li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">apiVersion:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> upgrade.cattle.io/v1</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">kind:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Plan</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">metadata:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  name:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> k3s-agent</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  namespace:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> system-upgrade</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  labels:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    k3s-upgrade:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> agent</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">spec:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  nodeSelector:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    matchExpressions:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      -</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> key:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> node-role.kubernetes.io/control-plane</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        operator:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> DoesNotExist</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  serviceAccountName:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> system-upgrade</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  prepare:</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  # Ensures server nodes are upgraded first</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    image:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> rancher/k3s-upgrade</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    args:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      -</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> prepare</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      -</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> k3s-server</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  concurrency:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  cordon:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> true</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  # Cordon node before upgrade</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  upgrade:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    image:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> rancher/k3s-upgrade</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  version:</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">new_versio</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">n</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span></span></code></pre></div><ul><li>Execute Upgrade Plans:</li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> kubectl</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --kubeconfig=/home/pi/.kube/config.yaml</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> apply</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -f</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> k3s-server-upgrade.yaml</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -f</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> k3s-agent-upgrade.yaml</span></span></code></pre></div><p>Check the output</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">plan.upgrade.cattle.io/k3s-server</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> created</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">plan.upgrade.cattle.io/k3s-agent</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> created</span></span></code></pre></div><h2 id="resetting-the-k3s-cluster" tabindex="-1">Resetting the K3S Cluster <a class="header-anchor" href="#resetting-the-k3s-cluster" aria-label="Permalink to &quot;Resetting the K3S Cluster&quot;">â€‹</a></h2><p>To reset the K3S cluster, run the K3S uninstallation scripts on both the master and worker nodes. This process will remove the K3S installation and configurations from each node.</p><ul><li>On Worker Nodes: Perform this step on each of the worker nodes in the cluster. Run the following command to uninstall K3S from a worker node:</li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">/usr/local/bin/k3s-agent-uninstall.sh</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> rm</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -rf</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /etc/rancher</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /var/lib/rancher</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /var/lib/kubelet</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /etc/cni</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /var/lib/etcd</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /run/k3s</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /run/flannel</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /usr/local/bin/k3s</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /usr/local/bin/kubectl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /var/lib/containerd/</span></span></code></pre></div><ul><li>On Master Nodes: Similarly, on each master node, execute the command below to uninstall K3S:</li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">/usr/local/bin/k3s-uninstall.sh</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> rm</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -rf</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /etc/rancher</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /var/lib/rancher</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /var/lib/kubelet</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /etc/cni</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /var/lib/etcd</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /run/k3s</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /run/flannel</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /usr/local/bin/k3s</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /usr/local/bin/kubectl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /var/lib/containerd/</span></span></code></pre></div><p>This approach ensures that K3S is properly removed from all nodes, effectively resetting the cluster. Remember, these commands must be executed on each node individually.</p><h2 id="enable-ansible-driven-remote-deployment-for-k3s-cluster" tabindex="-1">Enable Ansible-driven remote deployment for K3S Cluster <a class="header-anchor" href="#enable-ansible-driven-remote-deployment-for-k3s-cluster" aria-label="Permalink to &quot;Enable Ansible-driven remote deployment for K3S Cluster&quot;">â€‹</a></h2><p>To enable Ansible-driven remote deployment of pods in your K3s cluster, configure the primary master by installing the kubernetes Python package on <strong><code>blueberry-master</code></strong>. This package is necessary for the Ansible <a href="https://github.com/ansible-collections/kubernetes.core" target="_blank" rel="noreferrer"><strong><code>kubernetes.core collection</code></strong></a> to interact with your Kubernetes cluster.</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">echo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;export PATH=$PATH:/home/pi/.local/bin&#39;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &gt;&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ~/.bashrc</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">source</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ~/.bashrc</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> apt</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> install</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> python3-pip</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -y</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">pip3</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> install</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> kubernetes</span></span></code></pre></div>`,150))])}const m=e(d,[["render",g]]);export{C as __pageData,m as default};
