import{_ as s,c as e,a0 as i,o as t}from"./chunks/framework.p2VkXzrt.js";const l="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20role='img'%20viewBox='0.59%200.59%20236.82%20307.32'%3e%3ctitle%3eMetalLB%20logo%3c/title%3e%3cdefs%3e%3cstyle%3e.cls-1{fill:%233f51b4}%3c/style%3e%3c/defs%3e%3cpath%20d='M183.09%20180.256c-23.476-13.559-45.932-26.527-68.385-39.5-10.365-5.989-20.669-12.089-31.124-17.915-2.95-1.645-3.35-3.009-1.955-6.163%209.68-21.892%2019.1-43.899%2028.617-65.863%201.649-3.804%202.944-7.85%208.348-7.917%205.408-.067%206.751%203.815%208.437%207.706q27.052%2062.438%2054.182%20124.842c.515%201.188.946%202.413%201.88%204.81zM77.1%20127.09c1.382-3.25%202.491-3.737%205.67-1.807%2010.735%206.518%2021.703%2012.654%2033.286%2019.342l-60.763%2035.143'%20class='cls-1'/%3e%3cpath%20d='M119.126%20231.865a112.62%20112.62%200%201%201%20112.62-112.62%20112.747%20112.747%200%200%201-112.62%20112.62zm0-213.24a100.62%20100.62%200%201%200%20100.62%20100.62%20100.734%20100.734%200%200%200-100.62-100.62z'%20class='cls-1'/%3e%3cpath%20d='M37.118%20258.613h12.757v42.429h-8.261v-28.699q0-1.237.029-3.468.027-2.23.028-3.44l-8.04%2035.607h-8.617l-7.982-35.607q0%201.209.028%203.44.028%202.23.029%203.468v28.699h-8.26v-42.43h12.9l7.723%2033.362zm40.743%2011.689a12.766%2012.766%200%200%201%205.422%204.64%2015.419%2015.419%200%200%201%202.5%206.488%2040.106%2040.106%200%200%201%20.27%206.227h-22.85q.19%204.721%203.28%206.62a8.332%208.332%200%200%200%204.523%201.18%206.37%206.37%200%200%200%206.243-3.598h8.376a10.242%2010.242%200%200%201-3.041%205.67q-4.216%204.577-11.804%204.578a17.104%2017.104%200%200%201-11.051-3.86q-4.788-3.862-4.788-12.562%200-8.152%204.322-12.503a15.123%2015.123%200%200%201%2011.22-4.35%2017.856%2017.856%200%200%201%207.378%201.47zm-12.272%207.086a8.526%208.526%200%200%200-2.186%204.858h14.134a6.844%206.844%200%200%200-2.186-4.958%207.187%207.187%200%200%200-4.865-1.692%206.508%206.508%200%200%200-4.897%201.792zm21.389-1.591v-5.842h4.375v-8.751h8.118v8.75h5.094v5.843h-5.094v16.58a3.73%203.73%200%200%200%20.489%202.404q.49.474%202.994.474c.249%200%20.513-.003.791-.013q.417-.015.82-.044v6.132l-3.885.143q-5.815.2-7.945-2.014a6.001%206.001%200%200%201-1.382-4.347v-19.315zm35.282%206.161a12.94%2012.94%200%200%200%203.276-.72%202.469%202.469%200%200%200%201.77-2.332%202.755%202.755%200%200%200-1.358-2.662%208.573%208.573%200%200%200-3.983-.735q-2.946%200-4.172%201.44a5.938%205.938%200%200%200-1.167%202.879h-7.916a12.004%2012.004%200%200%201%202.313-6.765q3.267-4.145%2011.217-4.145a20.004%2020.004%200%200%201%209.193%202.044q4.018%202.044%204.018%207.714v14.392q0%201.497.057%203.627a4.56%204.56%200%200%200%20.49%202.187%202.931%202.931%200%200%200%201.209.95v1.21h-8.923a9.139%209.139%200%200%201-.519-1.785q-.143-.835-.23-1.9a16.92%2016.92%200%200%201-3.938%203.138%2011.9%2011.9%200%200%201-6.021%201.525%2010.387%2010.387%200%200%201-7.079-2.432%208.648%208.648%200%200%201-2.794-6.894q0-5.786%204.495-8.376a20.072%2020.072%200%200%201%207.25-2.016zm5.016%203.828a9.142%209.142%200%200%201-1.591.792%2013.4%2013.4%200%200%201-2.202.56l-1.868.346a12.292%2012.292%200%200%200-3.77%201.123%203.746%203.746%200%200%200-1.938%203.482%203.64%203.64%200%200%200%201.183%203.037%204.498%204.498%200%200%200%202.88.936%208.575%208.575%200%200%200%204.953-1.555q2.265-1.554%202.353-5.67zm23.719%2015.256h-8.205v-42.43h8.205zm8.664-42.429h8.866v34.8h21.185v7.629h-30.05zm67.654%204.519a10.794%2010.794%200%200%201%201.947%206.477%209.447%209.447%200%200%201-1.965%206.246%2010.143%2010.143%200%200%201-3.236%202.418%209.455%209.455%200%200%201%204.901%203.742%2011.228%2011.228%200%200%201%201.653%206.217%2012.402%2012.402%200%200%201-1.889%206.765%2011.682%2011.682%200%200%201-7.799%205.468%2029.314%2029.314%200%200%201-5.995.577h-19.117v-42.43h20.504q7.76.117%2010.996%204.52zm-23.038%202.85v9.354h10.312a8.527%208.527%200%200%200%204.487-1.05%204.007%204.007%200%200%200%201.723-3.727q0-2.965-2.278-3.915a15.978%2015.978%200%200%200-5.015-.662zm0%2016.378v11.312h10.3a10.01%2010.01%200%200%200%204.298-.748q2.789-1.38%202.788-5.296a4.556%204.556%200%200%200-2.703-4.548%2010.74%2010.74%200%200%200-4.24-.72z'/%3e%3c/svg%3e",g=JSON.parse('{"title":"Using Metal LB as a Load Balancer in K3S","description":"How to disable default K3S load balancer and configure a custom Metal LB as load balancer in PiKube Kubernetes Service.","frontmatter":{"title":"Using Metal LB as a Load Balancer in K3S","permalink":"/docs/5-networking/3-load-balancer-metal-lb/","description":"How to disable default K3S load balancer and configure a custom Metal LB as load balancer in PiKube Kubernetes Service.","last_modified_at":"12-11-2023"},"headers":[],"relativePath":"5-networking/2-load-balancer-metal-lb.md","filePath":"5-networking/2-load-balancer-metal-lb.md"}'),n={name:"5-networking/2-load-balancer-metal-lb.md"};function o(r,a,h,p,d,c){return t(),e("div",null,a[0]||(a[0]=[i('<p align="center"><img alt="metal-lb" src="'+l+`" width="30%" height="%"></p><ul><li><a href="#disabling-the-klipper-load-balancer">Disabling the Klipper Load Balancer</a></li><li><a href="#initial-services-post-installation">Initial Services Post-Installation</a></li><li><a href="#why-choose-metal-lb">Why Choose Metal LB?</a></li><li><a href="#metal-lbs-role">Metal LB&#39;s Role</a></li><li><a href="#how-metal-lb-operates">How Metal LB Operates</a></li><li><a href="#install-metal-load-balancer-using-helm">Install Metal Load Balancer using Helm</a></li></ul><p>Opting for <strong><code>Metal LB</code></strong> in place of the default <strong><code>Klipper Load Balancer</code></strong> in K3S is a strategic choice due to <strong><code>Metal LB</code></strong>&#39;s versatility and broad compatibility with different Kubernetes distributions. Its adaptability across various environments renders <strong><code>Metal LB</code></strong> a more favorable option for load balancing needs in Kubernetes.</p><h2 id="disabling-the-klipper-load-balancer" tabindex="-1">Disabling the Klipper Load Balancer <a class="header-anchor" href="#disabling-the-klipper-load-balancer" aria-label="Permalink to &quot;Disabling the Klipper Load Balancer&quot;">​</a></h2><p>To incorporate Metal LB, first disable the embedded Klipper Load Balancer in K3S. This is achieved using the <strong><code>--disable servicelb</code></strong> option during the K3S server installation performed during the <a href="https://github.com/Crypto-Aggressor/PiKube-Kubernetes-Cluster/blob/production/documentation/2.4-k3s-installation.md#3-setting-up-master-nodes" target="_blank" rel="noreferrer"><strong><code>Master Nodes Set Up</code></strong></a>.</p><h2 id="initial-services-post-installation" tabindex="-1">Initial Services Post-Installation <a class="header-anchor" href="#initial-services-post-installation" aria-label="Permalink to &quot;Initial Services Post-Installation&quot;">​</a></h2><p>Following the K3S installation with the disabled service load balancer, the default started pods and services include:</p><ul><li>Pods (Displayed using kubectl get pods --all-namespaces)</li><li>Services (Shown via kubectl get services --all-namespaces)</li></ul><h2 id="why-choose-metal-lb" tabindex="-1">Why Choose Metal LB? <a class="header-anchor" href="#why-choose-metal-lb" aria-label="Permalink to &quot;Why Choose Metal LB?&quot;">​</a></h2><p>In bare-metal Kubernetes clusters, services of type LoadBalancer remain in a &quot;pending&quot; state indefinitely, as seen above with the Traefik LoadBalancer service. Standard Kubernetes doesn&#39;t provide a network load balancer implementation for bare-metal environments. The typical options, &quot;NodePort&quot; and &quot;externalIPs,&quot; have limitations for production use, often relegating bare-metal clusters to a secondary status.</p><h2 id="metal-lb-s-role" tabindex="-1">Metal LB&#39;s Role <a class="header-anchor" href="#metal-lb-s-role" aria-label="Permalink to &quot;Metal LB&#39;s Role&quot;">​</a></h2><p>MetalLB bridges this gap, offering a network load balancer that integrates with standard network equipment. It enables external services on bare-metal clusters to be accessible via a pool of external IP addresses.</p><h2 id="how-metal-lb-operates" tabindex="-1">How Metal LB Operates <a class="header-anchor" href="#how-metal-lb-operates" aria-label="Permalink to &quot;How Metal LB Operates&quot;">​</a></h2><p>MetalLB operates in two key modes, Border Gateway Protocol (BGP) and Layer 2 Networking, and consists of two primary components:</p><ul><li><p><strong>Operational Modes</strong>:</p><ul><li><p><strong><code>Layer 2 Mode</code></strong></p><ul><li><strong><code>Universal Compatibility</code></strong>: Functions with any Ethernet network.</li><li><strong><code>Leader Node Role</code></strong>: Designates a leader node to advertise Kubernetes LoadBalancer services to the local network, making it appear as if the node possesses multiple IP addresses. This node responds to ARP (IPv4) and NDP (IPv6) requests.</li><li><strong><code>Simplicity and Compatibility:</code></strong>: Enables straightforward local network access to Kubernetes services, ideal for environments not requiring complex routing. While broadly compatible, it may lack the scalability and control of more intricate network setups.</li></ul></li><li><p><strong><code>BGP Mode</code></strong></p><ul><li><strong><code>Router Requirements</code></strong>: Necessitates specific routers to function effectively.</li><li><strong><code>Sophisticated Network Integration</code></strong>: Facilitates more dynamic and nuanced routing of traffic, making it suitable for environments demanding advanced routing capabilities and scalability.</li></ul></li></ul></li><li><p><strong>MetalLB Components</strong>:</p><ul><li><p><strong><code>Controller</code></strong>: Handles the allocation of IP addresses from a predefined pool, ensuring each service receives a unique external IP as needed.</p></li><li><p><strong><code>Speaker</code></strong>: Operates as a DaemonSet pod on each worker node, announcing the service IPs allocated by the Controller, thus facilitating network communication.</p></li></ul></li></ul><p>TODO pikube-metal-lb-architecture.drawio</p><ul><li><p><strong>Understanding the Networking Modes:</strong></p><ul><li><p><strong><code>Layer 2 Networking:</code></strong> At the data link layer, this mode provides local network access to Kubernetes services. Primarily serving as a failover mechanism, the leader node channels traffic for a service IP and kube-proxy disperses it across the service&#39;s pods.</p></li><li><p><strong><code>Border Gateway Protocol (BGP):</code></strong> A pivotal internet routing protocol, BGP in MetalLB allows for versatile and dynamic traffic routing, particularly beneficial in complex network environments where flexibility and scalability are paramount.</p></li></ul></li></ul><h2 id="install-metal-load-balancer-using-helm" tabindex="-1">Install Metal Load Balancer using Helm <a class="header-anchor" href="#install-metal-load-balancer-using-helm" aria-label="Permalink to &quot;Install Metal Load Balancer using Helm&quot;">​</a></h2><ul><li>Add the <strong><code>Metal LB</code></strong> Helm Repository</li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">helm</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> repo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> add</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> metallb</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> https://metallb.github.io/metallb</span></span></code></pre></div><ul><li>Update Helm Repositories to fetche the latest charts available in the <strong><code>Metal LB</code></strong> repository</li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">helm</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> repo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> update</span></span></code></pre></div><ul><li>Create a dedicated namespace for <strong><code>Metal LB</code></strong> for organizational purposes</li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">kubectl</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --kubeconfig=/home/pi/.kube/config.yaml</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> create</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> namespace</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> metal-lb</span></span></code></pre></div><ul><li>Install <strong><code>Metal LB</code></strong> in the specified namespace using Helm</li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">helm</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> install</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> metallb</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> metallb/metallb</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --namespace</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> metal-lb</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --kubeconfig=/home/pi/.kube/config.yaml</span></span></code></pre></div><ul><li>Verify the Deployment by confirming that the <strong><code>Metal LB</code></strong> pods are running successfully in the metal-lb namespace</li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">kubectl</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --kubeconfig=/home/pi/.kube/config.yaml</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -n</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> metal-lb</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> get</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> pod</span></span></code></pre></div><ul><li>Configure the <strong><code>IP Address Pool</code></strong> and <strong><code>Announcement Method</code></strong> (Layer 2 advertisement) by creating the <strong><code>metal-lb-config.yaml</code></strong> file</li></ul><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">---</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># MetalLB Address Pool Configuration</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># This defines a range of IP addresses that Metal LB controls and can assign.</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">apiVersion</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">metallb.io/v1beta1</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">kind</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">IPAddressPool</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">metadata</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">picluster-pool</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  namespace</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">metal-lb</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">spec</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  addresses</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">10.0.0.100-10.0.0.200</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">---</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Layer 2 Advertisement Configuration</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># This section configures Metal LB to use Layer 2 mode to advertise IP addresses.</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">apiVersion</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">metallb.io/v1beta1</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">kind</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">L2Advertisement</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">metadata</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">main-l2-advertisement</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  namespace</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">metal-lb</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">spec</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  ipAddressPools</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">picluster-pool</span></span></code></pre></div><ul><li>Apply the Manifest</li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">kubectl</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --kubeconfig=/home/pi/.kube/config.yaml</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> apply</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -f</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> metal-lb-config.yaml</span></span></code></pre></div><p>After applying the configuration, <strong><code>Metal LB</code></strong> will assign external IP addresses from the defined pool to services of type LoadBalancer, like <strong><code>Traefik</code></strong>.</p><p>Check LoadBalancer Services by listing all services in the cluster to check if the LoadBalancer services have been assigned an external IP</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">kubectl</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --kubeconfig=/home/pi/.kube/config.yaml</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> get</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> services</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --all-namespaces</span></span></code></pre></div>`,35)]))}const u=s(n,[["render",o]]);export{g as __pageData,u as default};
